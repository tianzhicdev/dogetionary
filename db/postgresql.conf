# PostgreSQL Configuration for Dogetionary
# Optimized for 4 vCPU, 16GB RAM VPS with 100+ concurrent users
#
# This file overrides default PostgreSQL settings for production performance

# =================================================================
# CONNECTION SETTINGS
# =================================================================

# Maximum number of concurrent connections
# Default: 100
# Our setting: 100 (50 for app pool + 50 for maintenance/monitoring/overhead)
max_connections = 100

# =================================================================
# MEMORY SETTINGS
# =================================================================

# Shared Buffers: Memory for caching database pages
# Rule of thumb: 25% of system RAM
# For 16GB RAM: 4GB
shared_buffers = 256MB

# Effective Cache Size: Helps query planner estimate memory available for caching
# Rule of thumb: 50-75% of system RAM
# For 16GB RAM: 12GB (75%)
effective_cache_size = 12GB

# Work Mem: Memory per sort/hash operation
# Too low = disk spills, too high = OOM risk
# Formula: (RAM - shared_buffers) / (max_connections * 3)
# = (16GB - 4GB) / (100 * 3) = 40MB
work_mem = 40MB

# Maintenance Work Mem: Memory for VACUUM, CREATE INDEX, etc.
# Rule of thumb: 5% of RAM or 1GB, whichever is smaller
maintenance_work_mem = 1GB

# =================================================================
# WRITE AHEAD LOG (WAL) SETTINGS
# =================================================================

# WAL Buffers: Memory for write-ahead log
# Rule of thumb: 3% of shared_buffers, max 16MB
# 3% of 4GB = 120MB, but default -1 (auto) is usually good
wal_buffers = -1

# Checkpoint Settings
# Balance between crash recovery time and write performance
checkpoint_completion_target = 0.9
min_wal_size = 1GB
max_wal_size = 4GB

# =================================================================
# QUERY PLANNER SETTINGS
# =================================================================

# Random Page Cost: Relative cost of random vs sequential I/O
# Default: 4.0 (for spinning disks)
# For SSD: 1.1-1.5 (faster random access)
random_page_cost = 1.1

# Effective IO Concurrency: Number of simultaneous disk I/O operations
# For SSD RAID: 200, For single SSD: 100, For HDD: 1-2
effective_io_concurrency = 200

# =================================================================
# LOGGING SETTINGS
# =================================================================

# Log slow queries for monitoring
log_min_duration_statement = 1000  # Log queries > 1 second

# Log checkpoints for monitoring
log_checkpoints = on

# Log connections/disconnections for monitoring
log_connections = off
log_disconnections = off

# Log lock waits > 1 second
log_lock_waits = on
deadlock_timeout = 1s

# =================================================================
# AUTOVACUUM SETTINGS
# =================================================================

# Autovacuum is critical for performance - keep it enabled
autovacuum = on

# More aggressive autovacuum for write-heavy workload
autovacuum_max_workers = 3
autovacuum_naptime = 30s  # Check for vacuum every 30 seconds (default 1min)

# =================================================================
# CLIENT CONNECTION SETTINGS
# =================================================================

# Default transaction isolation level
# Read Committed is standard for most apps
default_transaction_isolation = 'read committed'

# Timezone
timezone = 'UTC'

# =================================================================
# NOTES
# =================================================================
#
# This configuration is optimized for:
# - 4 vCPU, 16GB RAM VPS
# - 100 concurrent users
# - SSD storage
# - Mixed read/write workload (spaced repetition system)
# - Connection pooling in application (psycopg2 pool)
#
# To apply this configuration in Docker:
# 1. Mount this file as volume in docker-compose.yml
# 2. Pass as command: -c config_file=/etc/postgresql/postgresql.conf
#
# After changing these settings, you MUST restart PostgreSQL:
# docker-compose restart postgres
